<?php 
$equivalent = 0;
$partial = null;

?>
<script type="text/javascript">
      $(function() {
			$("#tableSort").tablesorter({debug: true});
		});  
    </script>
<table id="tableSort" class="tablesorter table table-striped "> 
<thead style="background: #E6EEEE;">
    <tr> 
        <th>Student</th>   
        <?php
        foreach($category as $cat)
        {
        ?>
            <th><?php echo $cat->category_name.' ( '.($cat->weight*100).'% )' ?></th>    
        <?php
        }
        ?>  
            <th>Partial Number Grade</th>
            <td>Partial Letter Grade</td>
        </tr>
</thead>
<tbody>
<?php 
foreach($students->result() as $student )
{
    ?>
<tr class="main"> 
    <td ><?php echo strtoupper($student->lastname.', '.$student->firstname) ?></td>
    <?php
        $a = 0;
        foreach($category as $cat => $k)
        {
        ?>
        <td style="cursor:pointer;  " onclick="getIndividualAssessment('<?php echo $student->user_id ?>',<?php echo $subject_id ?>,<?php echo $k->code ?>, <?php echo $this->session->userdata('term') ?>)" class="values" >
         <?php
          $record = Modules::run('gradingsystem/getTotalScoreByStudent', $student->user_id, $k->code, $this->session->userdata('term') , $subject_id);
          $numberOfAssessment = Modules::run('gradingsystem/getEachScoreByStudent', $student->user_id, $k->code, $this->session->userdata('term') , $subject_id);
          if($numberOfAssessment->num_rows>0){
              $record = $record->row();
              
              $partialAssess = round(($record->total/$numberOfAssessment->num_rows())*$record->weight, 3);
              
              echo round(($record->total/$numberOfAssessment->num_rows()), 3);
            }

        else{
            $a++;
            $partialAssess = $record->row()->weight*100;
                   echo 0;
           }
        if($a==4):
           $partialAssess = 0; 
        endif;
        $partial = $partial + $partialAssess; 

        
        $final = $partial;
        ?>
           </td>
           
        <?php
        }

        unset($partial);
        
        
?>    
    <td class="partial"><?php  echo round($final, 3); ?></td>  
    <td>
        <?php
         $partialGrade = round($final, 3);
         if($final!==0){
            $plg = Modules::run('gradingsystem/getLetterGrade', $final);
                foreach($plg->result() as $plg){
                    if( $final > $plg->from_grade && $final <= $plg->to_grade){
                        echo $plg->letter_grade;
                        echo $this->session->userdata('term');
                        
                    }
                }
                
            } ?>
    </td>  
</tr>
<?php
    $partial = 0;
    Modules::run('gradingsystem/recordPartialAssessment', $student->uid, $section_id , $subject_id, $this->session->userdata('term'), $this->session->userdata('school_year'), $partialGrade);
} //end of foreach

?>
</tbody>
</table>
    
 <script type="text/javascript">

$("td.values").each(function(){
    var sum = 0;
    $(this).nextUntil("td.values").each(function(){
            sum +=  parseInt($(this).find(".sum_values").text(), 10)

     });
    $(this).find(".partial").html(sum);
})


function getIndividualAssessment(st_id, subject, qcode, term){
          var url = "<?php echo base_url().'gradingsystem/getIndividualAssessment/'?>"; // the script where you handle the form input.

            $.ajax({
                   type: "POST",
                   url: url,
                   data: "st_id="+st_id+"&subject_id="+subject+"&qcode="+qcode+"&term="+term, // serializes the form's elements.
                   success: function(data)
                   {
                       $('#secretContainer').html(data)
                       $('#secretContainer').fadeIn(500)     
                   }
                 });

            return false;
    }
    

     </script>



